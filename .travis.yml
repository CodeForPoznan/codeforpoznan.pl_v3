os: linux
dist: xenial
language: python
python: 3.8

env:
  global:
    # app
    - FLASK_APP=app.py
    - FLASK_ENV=development
    - SECRET_KEY=codeforpoznan
    - BASE_URL=localhost
    - AWS_REGION=eu-west-1

    # db
    - DB_HOST=db
    - DB_PORT=5432
    - DB_NAME=cfp_v3
    - DB_USER=cfp_v3
    - DB_PASSWORD=cfp_v3

    # mail
    - MAIL_SERVER=
    - MAIL_PORT=
    - MAIL_USERNAME=
    - MAIL_PASSWORD=
    - MAIL_SUPPRESS_SEND=TRUE

    # deployment
    - STAGING_RESOURCE=dev_codeforpoznan_pl_v3
    - PRODUCTION_RESOURCE=codeforpoznan_pl_v3

install:
  - pip install awscli pipenv
  - nvm install 12
  - (cd frontend && yarn install)          # install frontend
  - (cd backend  && pipenv install --dev)  # install backend

script:
  - (cd frontend && yarn lint)        # lint frontend
  - (cd frontend && yarn test)        # test frontend
  - (cd backend  && pytest)           # test backend
  - (cd backend  && black --check .)  # lint backend

deploy:
  # staging -- https://dev.codeforpoznan.pl
  - provider: script
    skip_cleanup: true
    script: bash deploy.sh staging
    on:
      branch: master  # run on merge to master
      repo: CodeForPoznan/codeforpoznan.pl_v3

  # production -- https://codeforpoznan.pl
  - provider: script
    skip_cleanup: true
    script: bash deploy.sh production
    on:
      tags: true  # run on new tag (new github release)
      repo: CodeForPoznan/codeforpoznan.pl_v3
